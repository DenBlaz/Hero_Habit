{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendar</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" />
    <link rel="icon" href="{% static 'dashboard/image/logo_b.png' %}" type="image/png" />
    <link rel="stylesheet" href="{% static 'calend/css/calend-for-all.css' %}" />
  </head>
  <body>
    <div class="container">
      <div class="header1">
        <span><span class="bold">Hero</span>Habit</span>
      </div>

      <div class="header2">
        <div class="navigation">
          <ul>
            <li><a href="{% url 'dashboard:dashboard' %}">Dashboard</a></li>
            <li><a href="{% url 'stats:stats' %}">Statistics</a></li>
            <li><a class="active-page" href="{% url 'calend:calend' %}">Calendar</a></li>
            <li><a href="{% url 'achievements:achiev' %}">Achievements</a></li>
          </ul>
        </div>
        <div class="settings">
          <button id="toggle-icon" class="icon">
            <img src="{% static 'calend/images/settings.svg' %}" height="30px" />
          </button>
          <div class="panel" id="toggle-panel">
            <div class="title-settings">
              <div class="title">
                <img class="icon" src="{% static 'calend/images/settings.svg' %}" style="margin: 15px" />
                <p style="font-size: 34px; margin-top: 15px">Settings</p>
              </div>
              <a class="icon" id="close" style="margin: 15px">
                <img src="{% static 'calend/images/cross.svg' %}" />
              </a>
            </div>
            <div class="settings-container">
              <div class="settings-options">
                <ul class="options">
                  <li id="ViewProfileOption" class="option">Edit profile</li>
                  <li id="ChangePassword" class="option">Change password</li>
                </ul>
              </div>
              <div class="settings-profile-usage">
                <div class="settings-profile-section">
                  <p>Profile picture</p>
                  <img style="padding: 2% 0 1% 0; width: 80px" src="{% static 'calend/images/account.svg' %}" />
                </div>
                <div class="settings-username-section" style="padding: 1% 0 3% 0">
                  <p style="padding: 1% 0 1% 0">Username</p>
                  <input placeholder="Username" value="{{ request.user.nickname }}" />
                </div>
                <div class="settings-email-settings" style="padding-bottom: 4%">
                  <p style="padding: 1% 0 1% 0">Email</p>
                  <input placeholder="Email" value="{{ request.user.email }}" />
                </div>
                <button class="settings-button">
                  <img style="width: 14%" src="{% static 'calend/images/pen.svg' %}" /> Edit
                </button>
              </div>
              <div class="settings-change-password">
                <div class="settings-password-section" style="padding: 0 0 1.5% 0">
                  <p style="padding: 0 0 1% 0">Current password</p>
                  <input type="password" placeholder="Password" />
                </div>
                <div class="settings-change-section">
                  <p style="padding: 2% 0 1% 0">New password</p>
                  <input type="password" placeholder="Password" />
                </div>
                <div class="settings-change-section" style="padding: 0 0 4% 0">
                  <p style="padding: 3% 0 1% 0">Confirm new password</p>
                  <input type="password" placeholder="Password" />
                </div>
                <button class="settings-button">
                  <img src="{% static 'calend/images/pen.svg' %}" /> Save
                </button>
              </div>
            </div>
          </div>
          <button id="open-modal" class="icon">
            <img src="{% static 'calend/images/account.svg' %}" height="40px" />
          </button>
          <div id="overlay"></div>
        </div>
      </div>

      <div class="content">
        <div class="manage-section rounded">
          <div class="left-layout">
            <div class="lil-calendar">
              <div class="lil-container">
                <button class="change-month">
                  <img src="{% static 'dashboard/images/images/arrow2.png' %}" alt="previous month" class="change-month-icon">
                </button>
                <div class="lil-calendar">
                  <p class="regular font16px">{{ month }} {{ year }}</p>
                  <ul class="days">
                    <li>Mon</li>
                    <li>Tue</li>
                    <li>Wed</li>
                    <li>Thu</li>
                    <li>Fri</li>
                    <li>Sat</li>
                    <li>Sun</li>
                  </ul>
                  <div class="dates">
                    {% for date in week_dates %}
                      <button class="{% if date.day == selected_date.day %}selected-day{% endif %} {% if date.month != selected_date.month %}different-month{% endif %}">
                        {{ date.day }}
                      </button>
                    {% endfor %}
                  </div>
                </div>
                <button class="change-month">
                  <img src="{% static 'dashboard/images/images/arrow2.png' %}" alt="next month" class="change-month-icon">
                </button>
              </div>
            </div>

            <div class="categories-section">
              <p style="padding: 1px 1px 0 10px; font-weight: 600; font-size: 20px;">
                <strong>Categories</strong>
              </p>
              <div class="category">
                <img src="{% static 'calend/images/pink-ellipse.svg' %}" />
                <p>Creativity</p>
              </div>
              <div class="category">
                <img src="{% static 'calend/images/green-ellipse.svg' %}" />
                <p>Strength</p>
              </div>
              <div class="category">
                <img src="{% static 'calend/images/blue-ellipse.svg' %}" />
                <p>Intelligence</p>
              </div>
            </div>

            <div class="button-section">
              <button class="invisible-button" id="addTaskButton">
                <img src="{% static 'calend/images/plus.svg' %}" style="padding: 0 10px 0 10px" />Add a task
              </button>
            </div>

            <form action="{% url 'calend:taskcreate' %}" method="post" id="taskForm">
              {% csrf_token %}
              <input type="hidden" name="task_type" id="taskType" value="daily" />
              <input type="hidden" name="task_id" id="taskId" value="" />
              <div class="add-task" id="addTaskForm" style="display: none">
                <div class="title-task">
                  <p>Add a task</p>
                  <img src="{% static 'calend/images/at-cross.svg' %}" class="icon" style="width: 23px" />
                </div>
                <div class="at-work">
                  {% if form.errors %}
                    <div style="color: red;">
                      <p>Errors:</p>
                      <ul>
                        {% for field in form %}
                          {% if field.errors %}
                            {% for error in field.errors %}
                              <li>{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                          {% endif %}
                        {% endfor %}
                        {% if form.non_field_errors %}
                          {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                          {% endfor %}
                        {% endif %}
                      </ul>
                    </div>
                  {% endif %}

                  <p style="padding: 5px 0 5px 0">Title & Description</p>
                  <input class="at-input" name="title" placeholder="New task title" value="{{ form.title.value|default:'' }}" required />
                  <input class="at-input-i" name="description" placeholder="Description" value="{{ form.description.value|default:'' }}" style="background: url('{% static 'calend/images/lines-input.svg' %}') no-repeat 8px 65%;" />

                  <p style="padding: 1px 0 0 0">Date & Time</p>
                  <div id="dueDateSection">
                    <input class="at-input-i" id="dueDate" name="due_date" placeholder="DD.MM.YYYY" value="{{ form.due_date.value|date:'d.m.Y'|default:'' }}" style="margin: 10px 0 0 0; background: url('{% static 'calend/images/date-icon.svg' %}') no-repeat 8px center;" required />
                  </div>

                  <div class="task-time" id="dateDay" style="margin-top: 5px">
                    <input class="at-input-i" name="start_time" placeholder="00:00" value="{{ form.start_time.value|time:'H:i'|default:'' }}" style="background: url('{% static 'calend/images/clock-icon.svg' %}') no-repeat 8px center;" />
                    <input class="at-input-i" name="finish_time" placeholder="23:59" value="{{ form.finish_time.value|time:'H:i'|default:'' }}" style="background: url('{% static 'calend/images/clock-icon.svg' %}') no-repeat 8px center;" />
                  </div>

                  <div class="task-time1 hidden" id="dateMonth" style="margin-top: 5px">
                    <input class="at-input-i" id="startDate" name="start_date" placeholder="DD.MM.YYYY" value="{{ form.start_date.value|date:'d.m.Y'|default:'' }}" style="background: url('{% static 'calend/images/date-icon.svg' %}') no-repeat 8px center;" />
                    <input class="at-input-i" id="finishDate" name="finish_date" placeholder="DD.MM.YYYY" value="{{ form.finish_date.value|date:'d.m.Y'|default:'' }}" style="background: url('{% static 'calend/images/date-icon.svg' %}') no-repeat 8px center;" />
                  </div>

                  <p style="margin: 10px 0 0 0">Category</p>
                  <input type="hidden" name="characteristic" id="characteristic" value="{{ form.characteristic.value|default:'Creativity' }}" />
                  <div class="change-stats">
                    <img src="{% static 'calend/images/pink-ellipse.svg' %}" data-category="Creativity" data-chosen="{% static 'calend/images/Ch-R-ellipse.svg' %}" data-default="{% static 'calend/images/pink-ellipse.svg' %}" class="at-icon {% if form.characteristic.value == 'Creativity' or not form.characteristic.value %}chosen{% endif %}" />
                    <img src="{% static 'calend/images/green-ellipse.svg' %}" data-category="Strength" data-chosen="{% static 'calend/images/Ch-Gr-ellipse.svg' %}" data-default="{% static 'calend/images/green-ellipse.svg' %}" class="at-icon {% if form.characteristic.value == 'Strength' %}chosen{% endif %}" />
                    <img src="{% static 'calend/images/blue-ellipse.svg' %}" data-category="Intelligence" data-chosen="{% static 'calend/images/Ch-B-ellipse.svg' %}" data-default="{% static 'calend/images/blue-ellipse.svg' %}" class="at-icon {% if form.characteristic.value == 'Intelligence' %}chosen{% endif %}" />
                  </div>

                  <div class="buttons">
                    <button type="button" class="cancel-button" style="margin-right: 10px">Cancel</button>
                    <button type="submit" class="save-button">Save</button>
                  </div>
                </div>
              </div>
            </form>

            <div class="show-month-tasks" id="toggleView">
              <button class="invisible-button">
                <img id="toggleIcon" style="padding: 0 22px 0 22px" src="{% static 'calend/images/leftarrow.svg' %}" />
                <span id="toggleText">Show tasks for month</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Daily Calendar -->
        <div class="calendar-section" id="calendarView">
          <div class="days-section">
            <div class="day" style="border-top-left-radius: 10px"></div>
            {% for date in week_dates %}
              <button class="space" id="{{ date|date:'l' }}">
                <div>{{ date|date:'l' }} <strong>{{ date|date:'d' }}</strong></div>
              </button>
            {% endfor %}
          </div>
          <div class="time-section">
            <div class="time-column" id="time-column"></div>
            {% for date in week_dates %}
            <div class="time-column">
              {% for task in daily_tasks %}
                {% if task.due_date == date %}
                  <div
                    class="task-block {% if task.characteristic == 'Creativity' %}pink-bar{% elif task.characteristic == 'Strength' %}green-bar{% else %}blue-bar{% endif %} {% if task.completed %}completed{% endif %}"
                    style="grid-row: {{ task.start_time.hour|add:1 }} / {{ task.finish_time.hour|add:1 }};"
                    data-task-id="{{ task.id }}"
                    data-tooltip="{{ task.title }}: {{ task.description|default:'No description' }} ({{ task.start_time|time:'H:i' }} - {{ task.finish_time|time:'H:i' }})"
                  >
                    <p class="semi-bold font16px">{{ task.title }}</p>
                    <p class="font12px">{{ task.start_time|time:"H:i" }} - {{ task.finish_time|time:"H:i" }}</p>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Long Calendar -->
        <div class="calendar-section1 rounded" id="taskView" style="display: none">
          <div class="month-section">
            <div class="month-header">
              {% for month in "Jan,Feb,Mar" %}
                <div class="months">{{ month }}</div>
              {% endfor %}
            </div>
            <div class="month-grid">
              {% for task in long_tasks %}
                {% with start_col=task.start_date|date:'n' finish_col=task.finish_date|date:'n'|add:1 %}
                  <div
                    class="task-bar {% if task.characteristic == 'Creativity' %}pink-bar{% elif task.characteristic == 'Strength' %}green-bar{% else %}blue-bar{% endif %}"
                    style="grid-column: {% if start_col < 1 %}1{% else %}{{ start_col }}{% endif %} / {% if finish_col > 4 %}4{% else %}{{ finish_col }}{% endif %};"
                    data-task-id="{{ task.id }}"
                    data-tooltip="{{ task.title }}: {{ task.description|default:'No description' }} ({{ task.start_date|date:'d.m.Y' }} - {{ task.finish_date|date:'d.m.Y' }})"
                  >
                    {{ task.title }}
                  </div>
                {% endwith %}
              {% endfor %}
            </div>
          </div>
        </div>

        <div id="profile-modal" class="modal">
          <div class="modal-content rounded">
            <p>Account</p>
            <div class="flex-center">
              <img src="{% static 'calend/images/account.svg' %}" height="35px" />
              <div class="account-info light grey">
                <p>{{ request.user.nickname }}</p>
                <p>{{ request.user.email }}</p>
              </div>
            </div>
            <hr />
            <p>
              <a href="{% url 'accounts:logout' %}" class="inline log-out">
                Log out
                <img src="{% static 'calend/images/logOutSign.svg' %}" height="25px" />
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const modal = document.getElementById("profile-modal");
      const openModalBtn = document.getElementById("open-modal");
      openModalBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        openModalBtn.classList.add("circled");
      });
      window.addEventListener("click", (event) => {
        if (event.target === modal) {
          modal.style.display = "none";
          openModalBtn.classList.remove("circled");
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        const toggleIcon = document.getElementById("toggle-icon");
        const closeIcon = document.getElementById("close");
        const panel = document.getElementById("toggle-panel");
        const overlay = document.getElementById("overlay");
        const profileOption = document.getElementById("ViewProfileOption");
        const passwordOption = document.getElementById("ChangePassword");
        const profileSection = document.querySelector(".settings-profile-usage");
        const passwordSection = document.querySelector(".settings-change-password");

        profileOption.classList.add("active");
        profileSection.style.display = "block";
        passwordSection.style.display = "none";

        toggleIcon.addEventListener("click", () => {
          panel.style.display = "block";
          overlay.style.display = "block";
        });
        closeIcon.addEventListener("click", () => {
          panel.style.display = "none";
          overlay.style.display = "none";
        });
        overlay.addEventListener("click", () => {
          panel.style.display = "none";
          overlay.style.display = "none";
        });

        profileOption.addEventListener("click", function () {
          profileOption.classList.add("active");
          passwordOption.classList.remove("active");
          profileSection.style.display = "block";
          passwordSection.style.display = "none";
        });
        passwordOption.addEventListener("click", function () {
          passwordOption.classList.add("active");
          profileOption.classList.remove("active");
          profileSection.style.display = "none";
          passwordSection.style.display = "block";
        });
      });

      const timeColumns = document.querySelectorAll(".time-column");
      timeColumns.forEach((column) => {
        for (let i = 0; i < 24; i++) {
          const timeSlot = document.createElement("div");
          timeSlot.className = "time-slot";
          if (column.id === "time-column") {
            const hour = i % 12 === 0 ? 12 : i % 12;
            const period = i < 12 ? 'am' : 'pm';
            timeSlot.textContent = `${hour} ${period}`;
          }
          column.appendChild(timeSlot);
        }
      });

      const buttons = document.querySelectorAll(".space");
      let activeButton = null;
      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          if (activeButton) {
            activeButton.style.backgroundColor = "";
            activeButton.style.color = "";
            activeButton.style.borderBottom = "";
          }
          activeButton = button;
          button.style.backgroundColor = "rgba(228, 222, 249)";
          button.style.color = "#000000";
          button.style.borderBottom = "2px solid #8364E8";
        });
      });

      const taskForm = document.getElementById("addTaskForm");
      const titleText = document.querySelector(".title-task p");
      const inputFields = document.querySelectorAll(".add-task input, .add-task textarea");
      if (taskForm) taskForm.style.display = "none";

      function toggleTaskForm(changeTitle = false, changePlaceholder = false) {
        if (taskForm.style.display === "none" || taskForm.style.display === "") {
          taskForm.style.display = "block";
          if (changeTitle && titleText) titleText.textContent = "Edit Task";
          if (changePlaceholder) {
            inputFields.forEach((input) => {
              input.style.setProperty("--placeholder-color", "black");
              input.style.color = "black";
            });
          }
        } else {
          taskForm.style.display = "none";
          if (titleText) titleText.textContent = "Add a Task";
          inputFields.forEach((input) => {
            input.style.setProperty("--placeholder-color", "");
            input.style.color = "";
          });
        }
      }

      function addClickListener(selector, changeTitle = false, changePlaceholder = false) {
        document.querySelectorAll(selector).forEach((element) => {
          element.addEventListener("click", function (event) {
            event.stopPropagation();
            toggleTaskForm(changeTitle, changePlaceholder);
          });
        });
      }

      addClickListener(".side-bar", true, true);
      addClickListener(".task", true, true);

      const addTaskButton = document.getElementById("addTaskButton");
      if (addTaskButton) {
        addTaskButton.addEventListener("click", function (event) {
          event.stopPropagation();
          toggleTaskForm(false, false);
        });
      }

      document.querySelector(".title-task .icon")?.addEventListener("click", function () {
        taskForm.style.display = "none";
        if (titleText) titleText.textContent = "Add a Task";
        inputFields.forEach((input) => {
          input.style.setProperty("--placeholder-color", "");
          input.style.color = "";
        });
      });

      document.querySelector(".cancel-button")?.addEventListener("click", function () {
        taskForm.style.display = "none";
        if (titleText) titleText.textContent = "Add a Task";
        inputFields.forEach((input) => {
          input.style.setProperty("--placeholder-color", "");
          input.style.color = "";
        });
      });

      document.addEventListener("click", function (event) {
        if (
          taskForm.style.display === "block" &&
          !taskForm.contains(event.target) &&
          !event.target.closest(".side-bar") &&
          !event.target.closest(".task") &&
          event.target !== addTaskButton
        ) {
          taskForm.style.display = "none";
          if (titleText) titleText.textContent = "Add a Task";
          inputFields.forEach((input) => {
            input.style.setProperty("--placeholder-color", "");
            input.style.color = "";
          });
        }
      });

      const toggleButton = document.getElementById("toggleView");
      const calendarView = document.getElementById("calendarView");
      const taskView = document.getElementById("taskView");
      const toggleIcon = document.getElementById("toggleIcon");
      const toggleText = document.getElementById("toggleText");
      const dateDay = document.getElementById("dateDay");
      const dateMonth = document.getElementById("dateMonth");
      const dueDateSection = document.getElementById("dueDateSection");
      const dueDateInput = document.getElementById("dueDate");
      const startDateInput = document.getElementById("startDate");
      const finishDateInput = document.getElementById("finishDate");
      const taskType = document.getElementById("taskType");
      const addTask = document.querySelector(".add-task");
      let currentMode = "day";

      toggleButton.addEventListener("click", function () {
        const isMonthlyView = toggleButton.classList.toggle("activebutton");
        console.log("Switching mode. Is monthly view:", isMonthlyView);
        if (isMonthlyView) {
          currentMode = "month";
          calendarView.classList.add("hidden");
          taskView.classList.remove("hidden");
          toggleIcon.classList.add("flip-image");
          toggleText.textContent = "Show tasks for days";
          dateDay.classList.add("hidden");
          dateMonth.classList.remove("hidden");
          dueDateSection.classList.add("hidden");
          dueDateInput.removeAttribute("required");
          startDateInput.setAttribute("required", "");
          finishDateInput.setAttribute("required", "");
          taskType.value = "long";
          addTask.style.height = "370px";
          console.log("Switched to Long Tasks. taskType:", taskType.value);
        } else {
          currentMode = "day";
          calendarView.classList.remove("hidden");
          taskView.classList.add("hidden");
          toggleIcon.classList.remove("flip-image");
          toggleText.textContent = "Show tasks for months";
          dateDay.classList.remove("hidden");
          dateMonth.classList.add("hidden");
          dueDateSection.classList.remove("hidden");
          dueDateInput.setAttribute("required", "");
          startDateInput.removeAttribute("required");
          finishDateInput.removeAttribute("required");
          taskType.value = "daily";
          addTask.style.height = "470px";
          console.log("Switched to Daily Tasks. taskType:", taskType.value);
        }
      });

      function setTaskMode(mode) {
        console.log("Setting initial mode to:", mode);
        if (mode === "month") {
          currentMode = "month";
          calendarView.classList.add("hidden");
          taskView.classList.remove("hidden");
          toggleIcon.classList.add("flip-image");
          toggleText.textContent = "Show tasks for days";
          dateDay.classList.add("hidden");
          dateMonth.classList.remove("hidden");
          dueDateSection.classList.add("hidden");
          dueDateInput.removeAttribute("required");
          startDateInput.setAttribute("required", "");
          finishDateInput.setAttribute("required", "");
          taskType.value = "long";
          addTask.style.height = "370px";
        } else {
          currentMode = "day";
          calendarView.classList.remove("hidden");
          taskView.classList.add("hidden");
          toggleIcon.classList.remove("flip-image");
          toggleText.textContent = "Show tasks for months";
          dateDay.classList.remove("hidden");
          dateMonth.classList.add("hidden");
          dueDateSection.classList.remove("hidden");
          dueDateInput.setAttribute("required", "");
          startDateInput.removeAttribute("required");
          finishDateInput.removeAttribute("required");
          taskType.value = "daily";
          addTask.style.height = "470px";
        }
        console.log("Initial taskType:", taskType.value);
      }
      setTaskMode("{{ task_type|default:'day' }}");

      const images = document.querySelectorAll(".at-icon");
      images[0].src = images[0].dataset.chosen;
      images.forEach((img) => {
        img.addEventListener("click", () => {
          images.forEach((i) => {
            i.src = i.dataset.default;
            i.classList.remove("chosen");
        });
          img.src = img.dataset.chosen;
          img.classList.add("chosen");
          document.getElementById("characteristic").value = img.getAttribute("data-category");
        });
      });
    </script>
  </body>
</html>