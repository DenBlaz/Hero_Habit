{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendar</title>
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans"
      rel="stylesheet"
    />
    <link
      rel="icon"
      href="{% static 'dashboard/image/logo_b.png' %}"
      type="image/png"
    />
    <link
      rel="stylesheet"
      href="{% static 'calend/css/calend-for-all.css' %}"
    />
  </head>
  <body>
    <div class="container">
      <div class="header1">
        <span><span class="bold">Hero</span>Habit</span>
      </div>

      <div class="header2">
        <div class="navigation">
          <ul>
            <li><a href="{% url 'dashboard:dashboard' %}">Dashboard</a></li>
            <li><a href="{% url 'stats:stats' %}">Statistics</a></li>
            <li>
              <a class="active-page" href="{% url 'calend:calend' %}"
                >Calendar</a
              >
            </li>
            <li><a href="{% url 'achievements:achiev' %}">Achievements</a></li>
          </ul>
        </div>
        <div class="settings">
          <button id="toggle-icon" class="icon">
            <img
              src="{% static 'calend/images/settings.svg' %}"
              height="30px"
            />
          </button>
          <div class="panel" id="toggle-panel">
            <div class="title-settings">
              <div class="title">
                <img
                  class="icon"
                  src="{% static 'calend/images/settings.svg' %}"
                  style="margin: 15px"
                />
                <p style="font-size: 34px; margin-top: 15px">Settings</p>
              </div>
              <a class="icon" id="close" style="margin: 15px">
                <img src="{% static 'calend/images/cross.svg' %}" />
              </a>
            </div>
            <div class="settings-container">
              <div class="settings-options">
                <ul class="options">
                  <li id="ViewProfileOption" class="option">Edit profile</li>
                  <li id="ChangePassword" class="option">Change password</li>
                </ul>
              </div>
              <div class="settings-profile-usage">
                <div class="settings-profile-section">
                  <p>Profile picture</p>
                  <img
                    style="padding: 2% 0 1% 0; width: 80px"
                    src="{% static 'calend/images/account.svg' %}"
                  />
                </div>
                <div
                  class="settings-username-section"
                  style="padding: 1% 0 3% 0"
                >
                  <p style="padding: 1% 0 1% 0">Username</p>
                  <input
                    placeholder="Username"
                    value="{{ request.user.nickname }}"
                  />
                </div>
                <div class="settings-email-settings" style="padding-bottom: 4%">
                  <p style="padding: 1% 0 1% 0">Email</p>
                  <input placeholder="Email" value="{{ request.user.email }}" />
                </div>
                <button class="settings-button">
                  <img
                    style="width: 14%"
                    src="{% static 'calend/images/pen.svg' %}"
                  />
                  Edit
                </button>
              </div>
              <div class="settings-change-password">
                <div
                  class="settings-password-section"
                  style="padding: 0 0 1.5% 0"
                >
                  <p style="padding: 0 0 1% 0">Current password</p>
                  <input type="password" placeholder="Password" />
                </div>
                <div class="settings-change-section">
                  <p style="padding: 2% 0 1% 0">New password</p>
                  <input type="password" placeholder="Password" />
                </div>
                <div class="settings-change-section" style="padding: 0 0 4% 0">
                  <p style="padding: 3% 0 1% 0">Confirm new password</p>
                  <input type="password" placeholder="Password" />
                </div>
                <button class="settings-button">
                  <img src="{% static 'calend/images/pen.svg' %}" /> Save
                </button>
              </div>
            </div>
          </div>
          <button id="open-modal" class="icon">
            <img src="{% static 'calend/images/account.svg' %}" height="40px" />
          </button>
          <div id="overlay"></div>
        </div>
      </div>

      <div class="content">
        <div class="manage-section rounded">
          <div class="left-layout">
            <div class="lil-calendar">
              <div class="lil-container">
                <button class="change-month">
                  <img
                    class="change-month-icon"
                    src="{% static 'calend/images/arrow2.svg' %}"
                  />
                </button>
                <p><strong>{% now "F Y" %}</strong></p>
                <button class="change-month">
                  <img
                    class="change-month-icon"
                    src="{% static 'calend/images/arrow1.svg' %}"
                  />
                </button>
              </div>
              <!-- When clicked, arrows should change the month -->
              <ul class="days" style="margin-top: 15px; margin-bottom: 10px">
                <li>Mon</li>
                <li>Tue</li>
                <li>Wed</li>
                <li>Thu</li>
                <li>Fri</li>
                <li>Sat</li>
                <li>Sun</li>
              </ul>
              <div class="dates selected-week">
                <button class="previous-month">30</button>
                <button class="previous-month">31</button>
                <button class="selected-day">1</button>
                <button>2</button>
                <button>3</button>
                <button>4</button>
                <button>5</button>
              </div>
              <div class="dates">
                <button>6</button><button>7</button><button>8</button>
                <button>9</button><button>10</button><button>11</button>
                <button>12</button>
              </div>
              <div class="dates">
                <button>13</button><button>14</button><button>15</button>
                <button>16</button><button>17</button><button>18</button>
                <button>19</button>
              </div>
              <div class="dates">
                <button>20</button><button>21</button><button>22</button>
                <button>23</button><button>24</button><button>25</button>
                <button>26</button>
              </div>
              <div class="dates">
                <button>27</button><button>28</button><button>29</button>
                <button>30</button><button>31</button>
                <button class="next-month">1</button>
                <button class="next-month">2</button>
              </div>
              <!-- When clicked on a day, it should update the selected week and day -->
            </div>

            <div class="categories-section">
              <p
                style="
                  padding: 1px 1px 0 10px;
                  font-weight: 600;
                  font-size: 20px;
                "
              >
                <strong>Categories</strong>
              </p>
              <div class="category">
                <img src="{% static 'calend/images/pink-ellipse.svg' %}" />
                <p>Creativity</p>
              </div>
              <div class="category">
                <img src="{% static 'calend/images/green-ellipse.svg' %}" />
                <p>Strength</p>
              </div>
              <div class="category">
                <img src="{% static 'calend/images/blue-ellipse.svg' %}" />
                <p>Intelligence</p>
              </div>
            </div>

            <div class="button-section">
              <button class="invisible-button" id="addTaskButton">
                <img
                  src="{% static 'calend/images/plus.svg' %}"
                  style="padding: 0 10px 0 10px"
                />Add a task
              </button>
            </div>

            <form
              action="{% url 'calend:taskcreate' %}"
              method="post"
              id="taskForm"
            >
              {% csrf_token %}
              <input
                type="hidden"
                name="task_type"
                id="taskType"
                value="daily"
              />
              <div class="add-task" id="addTaskForm" style="display: none">
                <div class="title-task">
                  <p>Add a task</p>
                  <img
                    src="{% static 'calend/images/at-cross.svg' %}"
                    class="icon"
                    style="width: 23px"
                    onclick="document.getElementById('addTaskForm').style.display='none'"
                  />
                </div>
                <div class="at-work">
                  <p style="padding: 5px 0 5px 0">Title & Description</p>
                  <input
                    class="at-input"
                    name="title"
                    placeholder="New task title"
                    required
                  />
                  <input
                    class="at-input-i"
                    name="description"
                    placeholder="Description"
                    style="
                      background: url('{% static 'calend/images/lines-input.svg' %}')
                        no-repeat 8px 65%;
                    "
                  />

                  <p style="padding: 1px 0 0 0">Date & Time</p>
                  <!-- Due date field for DailyTask -->
                  <div id="dueDateSection">
                    <input
                      class="at-input-i"
                      id="toggleDate"
                      name="due_date"
                      placeholder="DD.MM.YYYY"
                      style="
                        margin: 10px 0 0 0;
                        background: url('{% static 'calend/images/date-icon.svg' %}')
                          no-repeat 8px center;
                      "
                    />
                  </div>

                  <!-- Block for DailyTask (day mode) -->
                  <div class="task-time" id="dateDay" style="margin-top: 5px">
                    <input
                      class="at-input-i"
                      name="start_time"
                      placeholder="00:00"
                      style="
                        background: url('{% static 'calend/images/clock-icon.svg' %}')
                          no-repeat 8px center;
                      "
                    />
                    <input
                      class="at-input-i"
                      name="finish_time"
                      placeholder="23:59"
                      style="
                        background: url('{% static 'calend/images/clock-icon.svg' %}')
                          no-repeat 8px center;
                      "
                    />
                  </div>

                  <!-- Block for LongTask (month mode) -->
                  <div
                    class="task-time1"
                    id="dateMonth"
                    style="margin-top: 5px; display: none"
                  >
                    <input
                      class="at-input-i"
                      name="start_date"
                      placeholder="DD.MM.YYYY"
                      style="
                        background: url('{% static 'calend/images/date-icon.svg' %}')
                          no-repeat 8px center;
                      "
                      required
                    />
                    <input
                      class="at-input-i"
                      name="finish_date"
                      placeholder="DD.MM.YYYY"
                      style="
                        background: url('{% static 'calend/images/date-icon.svg' %}')
                          no-repeat 8px center;
                      "
                      required
                    />
                  </div>

                  <p style="margin: 10px 0 0 0">Category</p>
                  <input
                    type="hidden"
                    name="characteristic"
                    id="characteristic"
                    value="Creativity"
                  />
                  <div class="change-stats">
                    <img
                      src="{% static 'calend/images/pink-ellipse.svg' %}"
                      data-category="Creativity"
                      data-chosen="{% static 'calend/images/Ch-R-ellipse.svg' %}"
                      data-default="{% static 'calend/images/pink-ellipse.svg' %}"
                      class="at-icon chosen"
                    />
                    <img
                      src="{% static 'calend/images/green-ellipse.svg' %}"
                      data-category="Strength"
                      data-chosen="{% static 'calend/images/Ch-Gr-ellipse.svg' %}"
                      data-default="{% static 'calend/images/green-ellipse.svg' %}"
                      class="at-icon"
                    />
                    <img
                      src="{% static 'calend/images/blue-ellipse.svg' %}"
                      data-category="Intelligence"
                      data-chosen="{% static 'calend/images/Ch-B-ellipse.svg' %}"
                      data-default="{% static 'calend/images/blue-ellipse.svg' %}"
                      class="at-icon"
                    />
                  </div>

                  <div class="buttons">
                    <button
                      type="button"
                      class="cancel-button"
                      style="margin-right: 10px"
                      onclick="document.getElementById('addTaskForm').style.display='none'"
                    >
                      Cancel
                    </button>
                    <button type="submit" class="save-button">Save</button>
                  </div>
                </div>
              </div>
            </form>

            <div class="show-month-tasks" id="toggleView">
              <button class="invisible-button" id="toggleButton">
                <img
                  id="toggleIcon"
                  style="padding: 0 22px 0 22px"
                  src="{% static 'calend/images/leftarrow.svg' %}"
                />
                <span id="toggleText">Show tasks for month</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Calendar for days -->
        <div class="calendar-section" id="calendarView">
          <div class="calendar-grid">
            <!-- Header: Days of the Week -->
            <div class="grid-header">
              <div class="time-label"></div>
              <!-- Empty cell for time column -->
              {% for day in days_of_week %}
              <div class="day-header">
                {{ day.day }} <strong>{{ day.date }}</strong>
              </div>
              {% endfor %}
            </div>

            <!-- Grid: Time Slots and Tasks -->
            <div class="grid-body">
              <!-- Time Labels (Y-Axis) -->
              <div class="time-column">
                {% for hour in time_slots %}
                <div class="time-slot">{{ hour }}</div>
                {% endfor %}
              </div>

              <!-- Grid Columns for Each Day -->
              {% for day in days_of_week %}
              <div class="day-column" data-day="{{ day.date }}">
                <!-- Tasks will be dynamically inserted here -->
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Calendar for months -->
        <div
          class="calendar-section1 rounded"
          id="taskView"
          style="display: none"
        >
          <div class="task-section">
            {% for task in long_tasks %}
            <button class="task">
              <p class="semi-bold font16px">{{ task.title }}</p>
              <p class="font12px">
                {{ task.start_date|date:"d.m.Y" }} - {{
                task.finish_date|date:"d.m.Y" }}
              </p>
            </button>
            {% endfor %}
          </div>
          <div class="month-section">
            <div class="month">
              <div class="months">January</div>
              <div class="months active-month">February</div>
              <div class="months">March</div>
              <div class="months">April</div>
              <div class="months">May</div>
              <div class="months">June</div>
              <div class="months">July</div>
              <div class="months">August</div>
              <div class="months">September</div>
              <div class="months">October</div>
              <div class="months">November</div>
              <div class="months">December</div>
            </div>
            <div class="month">
              {% for task in long_tasks %}
              <button
                class="top-bar {% if task.characteristic == 'Creativity' %}pink-bar{% elif task.characteristic == 'Strength' %}green-bar{% else %}blue-bar{% endif %}"
              >
                <span class="start-date"
                  >{{ task.start_date|date:"d.m.Y" }}</span
                >
                <span class="end-date"
                  >{{ task.finish_date|date:"d.m.Y" }}</span
                >
              </button>
              {% endfor %}
            </div>
            <div class="blankmonth">
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
              <div class="months"></div>
            </div>
          </div>
        </div>

        <!-- Profile modal -->
        <div id="profile-modal" class="modal">
          <div class="modal-content rounded">
            <p>Account</p>
            <div class="flex-center">
              <img
                src="{% static 'calend/images/account.svg' %}"
                height="35px"
              />
              <div class="account-info light grey">
                <p>{{ request.user.nickname }}</p>
                <p>{{ request.user.email }}</p>
              </div>
            </div>
            <hr />
            <p>
              <a href="{% url 'accounts:logout' %}" class="inline log-out"
                >Log out<img
                  src="{% static 'calend/images/logOutSign.svg' %}"
                  height="25px"
              /></a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
            // Show task creation form
            document
              .getElementById("addTaskButton")
              .addEventListener("click", function () {
                document.getElementById("addTaskForm").style.display = "block";
              });

            // Category selection
            document.querySelectorAll(".change-stats img").forEach(function (img) {
              img.addEventListener("click", function () {
                document.querySelectorAll(".change-stats img").forEach(function (i) {
                  i.classList.remove("chosen");
                  i.src = i.getAttribute("data-default");
                });
                this.classList.add("chosen");
                this.src = this.getAttribute("data-chosen");
                document.getElementById("characteristic").value =
                  this.getAttribute("data-category");
              });
            });

            // Calendar mode switching
            const toggleButton = document.getElementById("toggleButton");
            const toggleIcon = document.getElementById("toggleIcon");
            const toggleText = document.getElementById("toggleText");
            const dateDay = document.getElementById("dateDay");
            const dateMonth = document.getElementById("dateMonth");
            const dueDateSection = document.getElementById("dueDateSection");
            const dueDateInput = document.getElementById("toggleDate");
            const taskType = document.getElementById("taskType");
            const calendarView = document.getElementById("calendarView");
            const taskView = document.getElementById("taskView");
            let currentMode = "day";

            toggleButton.addEventListener("click", function () {
              if (currentMode === "day") {
                currentMode = "month";
                toggleText.textContent = "Show tasks for day";
                toggleIcon.src = '{% static "calend/images/rightarrow.svg" %}';
                dateDay.style.display = "none";
                dateMonth.style.display = "block";
                dueDateSection.style.display = "none";
                dueDateInput.removeAttribute("required");
                taskType.value = "long";
                calendarView.style.display = "none";
                taskView.style.display = "block";
              } else {
                currentMode = "day";
                toggleText.textContent = "Show tasks for month";
                toggleIcon.src = '{% static "calend/images/leftarrow.svg" %}';
                dateDay.style.display = "block";
                dateMonth.style.display = "none";
                dueDateSection.style.display = "block";
                dueDateInput.setAttribute("required", "");
                taskType.value = "daily";
                calendarView.style.display = "block";
                taskView.style.display = "none";
              }
            });

            // Set initial mode
            function setTaskMode(mode) {
              if (mode === "month") {
                dateDay.style.display = "none";
                dateMonth.style.display = "block";
                dueDateSection.style.display = "none";
                dueDateInput.removeAttribute("required");
                taskType.value = "long";
                toggleText.textContent = "Show tasks for day";
                toggleIcon.src = '{% static "calend/images/rightarrow.svg" %}';
                calendarView.style.display = "none";
                taskView.style.display = "block";
              } else {
                dateDay.style.display = "block";
                dateMonth.style.display = "none";
                dueDateSection.style.display = "block";
                dueDateInput.setAttribute("required", "");
                taskType.value = "daily";
                toggleText.textContent = "Show tasks for month";
                toggleIcon.src = '{% static "calend/images/leftarrow.svg" %}';
                calendarView.style.display = "block";
                taskView.style.display = "none";
              }
            }
            setTaskMode(currentMode);

            // Settings and profile modal
            document
              .getElementById("toggle-icon")
              .addEventListener("click", function () {
                document.getElementById("toggle-panel").style.display = "block";
              });
            document.getElementById("close").addEventListener("click", function () {
              document.getElementById("toggle-panel").style.display = "none";
            });
            document
              .getElementById("open-modal")
              .addEventListener("click", function () {
                document.getElementById("profile-modal").style.display = "block";
              });

              // Dynamically place tasks in the grid
      document.addEventListener('DOMContentLoaded', function () {
        // Define time slots and their corresponding hours (for calculation)
        const timeSlots = {
          '9 am': 9,
          '10 am': 10,
          '11 am': 11,
          '12 pm': 12,
          '1 pm': 13,
          '2 pm': 14
        };

        // Get all daily tasks from the template
        const tasks = [
          {% for task in daily_tasks %}
          {
            title: "{{ task.title }}",
            start_time: "{{ task.start_time|time:'H:i' }}",
            finish_time: "{{ task.finish_time|time:'H:i' }}",
            characteristic: "{{ task.characteristic }}",
            due_date: "{{ task.due_date|date:'d' }}"
          },
          {% endfor %}
        ];

        // Place each task in the correct column and time slot
        tasks.forEach(task => {
          // Find the column for the task's due date
          const dayColumn = document.querySelector(`.day-column[data-day="${task.due_date}"]`);
          if (!dayColumn) return; // Skip if no matching day

          // Calculate start and end hours
          const startHour = parseInt(task.start_time.split(':')[0]);
          const startMinute = parseInt(task.start_time.split(':')[1]);
          const endHour = parseInt(task.finish_time.split(':')[0]);
          const endMinute = parseInt(task.finish_time.split(':')[1]);

          // Calculate the top position and height of the task block
          const slotHeight = 60; // Height of each time slot in pixels
          const startPosition = (startHour - 9) * slotHeight + (startMinute / 60) * slotHeight;
          const duration = (endHour + endMinute / 60) - (startHour + startMinute / 60);
          const height = duration * slotHeight;

          // Create the task block
          const taskBlock = document.createElement('div');
          taskBlock.classList.add('task-block');
          if (task.characteristic === 'Creativity') {
            taskBlock.classList.add('pink-bar');
          } else if (task.characteristic === 'Strength') {
            taskBlock.classList.add('green-bar');
          } else if (task.characteristic === 'Intelligence') {
            taskBlock.classList.add('blue-bar');
          }

          // Add task details
          taskBlock.innerHTML = `
            <p class="semi-bold font12px">${task.title}</p>
            <p class="font10px">${task.start_time} - ${task.finish_time}</p>
          `;

          // Set position and height
          taskBlock.style.top = `${startPosition}px`;
          taskBlock.style.height = `${height}px`;

          // Append to the day column
          dayColumn.appendChild(taskBlock);
        });
      });
    </script>
  </body>
</html>
